@using ReadingDiary.Web.Models.ViewModels
@model ReadingDiary.Web.Models.ViewModels.BooksFeedViewModel

@{
    ViewData["Title"] = "Katalog knih";
    ViewData["PageTitle"] = "Katalog knih";
    ViewData["PageDescription"] = "Procházej, filtruj a objevuj knihy v čtenářském deníku";
}

<!-- HEADER -->
@await Html.PartialAsync("_PageHeaderPartial")

<div class="mt-4">

    <!-- GENRE FILTER -->
    <div class="mb-4">

        <a asp-action="Index"
           class="badge bg-dark genre-badge px-3 py-2 fs-6 me-2 text-decoration-none">
            Vše
        </a>


        @foreach (var genre in Model.Genres)
        {
            <a asp-action="Index"
               asp-route-genreId="@genre.Id"
               asp-route-search="@Model.Search"
               asp-route-sort="@Model.Sort"
               class="badge genre-badge px-3 py-2 fs-6 me-2 mb-2 text-decoration-none @(Model.SelectedGenreId == genre.Id ? "bg-primary" : "bg-secondary")">
                @genre.Name
            </a>
        }
    </div>

    <!-- SEARCH -->
    <form method="get"
          asp-action="Index"
          class="mb-4 d-flex gap-2 align-items-center">

        <input type="text"
               name="search"
               class="form-control"
               placeholder="Hledat knihu nebo autora…"
               value="@Model.Search" />

        <input type="hidden" name="genreId" value="@Model.SelectedGenreId" />
        <input type="hidden" name="sort" value="@Model.Sort" />

        <button class="btn btn-primary">Hledat</button>

        @if (!string.IsNullOrWhiteSpace(Model.Search) || Model.SelectedGenreId.HasValue)
        {
            <a asp-action="Index"
               class="btn btn-outline-danger">
                ╳
            </a>
        }
    </form>

    <!-- SORT -->
    <form method="get"
          asp-action="Index"
          class="mb-4">

        <select name="sort" class="form-select w-auto d-inline" onchange="this.form.submit()">
            <option value="">Nejnovější</option>
            <option value="title" selected="@(Model.Sort == "title")">Název (A–Z)</option>
            <option value="author" selected="@(Model.Sort == "author")">Autor (A–Z)</option>
            <option value="rating" selected="@(Model.Sort == "rating")">Hodnocení</option>
        </select>

        <input type="hidden" name="search" value="@Model.Search" />
        <input type="hidden" name="genreId" value="@Model.SelectedGenreId" />
    </form>

    <!-- NO RESULTS -->
    @if (Model.NoResults)
    {
        <div class="alert alert-light border text-center py-5 mt-4 shadow-sm">
            <div class="fs-4 mb-3">
                Nic jsme nenašli
            </div>

            <p class="text-muted mb-4">
                Zkuste upravit filtr, změnit hledaný výraz nebo zobrazit všechny knihy.
            </p>

            <a asp-action="Index" class="btn btn-outline-primary">
                Zpět na katalog knih
            </a>
        </div>
    }
    else
    {
        <!-- BOOK GRID -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
            @foreach (var book in Model.Books)
            {
                <div class="col">

                    <!-- CARD -->
                    <div class="card h-100 shadow-sm book-card" onclick="window.location='/Books/Details/@book.Id'">

                        <div style="height:260px; background:#fff; border-bottom:1px solid #f0f0f0;">
                            @if (!string.IsNullOrEmpty(book.CoverImagePath))
                            {
                                <img src="/BookCovers/@book.CoverImagePath"
                                     class="card-img-top"
                                     style="height:100%; width:100%; object-fit:contain; padding:10px;" />
                            }
                            else
                            {
                                <div style="height:100%; background:#f7f7f7; border:1px dashed #ccc;"></div>
                            }
                        </div>

                        <div class="card-body d-flex flex-column">

                            <h5 class="mb-1">@book.Title</h5>
                            <div class="text-muted small">@book.Author</div>

                            <div class="mt-2 mb-3">
                                @foreach (var genre in book.Genres)
                                {
                                    <span class="badge bg-secondary me-1">@genre</span>
                                }
                            </div>

                            <!-- RATING -->
                            @await Html.PartialAsync("_BookRatingPartial", new RatingViewModel
                            {
                                BookId = book.Id,
                                        AverageRating = book.AverageRating,
                                        RatingsCount = book.RatingsCount,
                                        UserRating = book.UserRating,
                                        IsReadOnly = true
                                        })

                            <a asp-controller="Books"
                               asp-action="Details"
                               asp-route-id="@book.Id"
                               class="btn btn-sm btn-outline-secondary mt-auto">
                                Detail knihy
                            </a>
                        </div>
                    </div>
                </div>
             }
        </div>
    }

    <!-- PAGINATION -->
    <div class="mt-4">
        @await Html.PartialAsync("_PaginationPartial")
    </div>

</div>